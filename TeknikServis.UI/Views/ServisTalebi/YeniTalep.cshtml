@model TeknikServis.UI.Models.ServisTalebi

@{
    ViewData["Title"] = "Teknik Servis Talebi";
    var kullaniciId = Context.Session.GetInt32("kullaniciId") ?? 0;
}

<h2 class ="mb-4 text-center text-info">Teknik Servis Talebi Oluştur</h2>

<form id="talepForm" asp-action="YeniTalep">
    <div class="form-group">
        <label for="urunAdi">Ürün Adı</label>
        <select asp-for="UrunId" name="UrunId" id="UrunId" asp-items="ViewBag.Urunler" class="form-control"></select>
    </div>

    <div class="form-group">
        <label for="aciklama">Açıklama</label>
        <textarea class="form-control" id="aciklama" name="aciklama" required></textarea>
    </div>

    <input type="hidden" id="kullaniciIdInput" value="@kullaniciId" />

  @*   <input type="submit" value="Gönder"/> *@
   <button type="button" onclick="talepGonder()" class="btn btn-primary btn-sm rounded shadow-sm px-3">Gönder</button> 
</form>

<script>
    function talepGonder() {
        const kullaniciId = parseInt(document.getElementById("kullaniciIdInput").value);

        if (!kullaniciId || isNaN(kullaniciId)) {
            alert("Kullanıcı bilgisi alınamadı.");
            return;
        }

        const talep = {
           urunAdi: "",
           urunId: document.getElementById("UrunId").value,
            aciklama: document.getElementById("aciklama").value,
            kullaniciId: kullaniciId,
            talepDurumu: "Oluşturuldu",
            talepTarihi: new Date().toISOString()
        };

        fetch("https://localhost:44365/api/ServisTalebi", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "kullaniciId": kullaniciId  // Session'dan gelen ID'yi header'a ekliyoruz
            },
            body: JSON.stringify(talep)
        })
        .then(response => {
            if (response.ok) {
                alert("Talep başarıyla gönderildi!");
                location.reload();
            } else {
                response.text().then(text => alert("Sunucu hatası: " + text));
            }
        })
        .catch(error => {
            console.error("Fetch hatası:", error);
            alert("Beklenmedik bir hata oluştu.");
        });
    }
</script>
