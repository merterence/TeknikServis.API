@{
    ViewData["Title"] = "Teknik Servis Talebi";
}

<h2>Teknik Servis Talebi Oluştur</h2>

<form id="talepForm">
    <div class="form-group">
        <label for="urunAdi">Ürün Adı</label>
        <input type="text" class="form-control" id="urunAdi" name="urunAdi" required />
    </div>

    <div class="form-group">
        <label for="aciklama">Açıklama</label>
        <textarea class="form-control" id="aciklama" name="aciklama" required></textarea>
    </div>

    <!-- ✅ Kullanıcı Id bilgisi için hidden input -->
    <input type="hidden" id="kullaniciIdInput" />

    <button type="button" onclick="talepGonder()" class="btn btn-primary">Gönder</button>
</form>

<script>
    // ✅ Sayfa açıldığında localStorage'dan KullaniciId alıp inputa yaz
    document.addEventListener("DOMContentLoaded", function () {
        var kullaniciId = localStorage.getItem("kullaniciId");
        document.getElementById('kullaniciIdInput').value = kullaniciId;
    });

    function talepGonder() {
        var kullaniciId = document.getElementById('kullaniciIdInput').value;

        if (!kullaniciId) {
            alert("Kullanıcı bilgisi bulunamadı. Lütfen giriş yapın.");
            return;
        }

        var talep = {
            urunAdi: document.getElementById("urunAdi").value,
            aciklama: document.getElementById("aciklama").value,
            kullaniciId: parseInt(kullaniciId),
            talepDurumu: "Oluşturuldu",   // ✅ Kullanıcı görmüyor, biz gönderiyoruz
            talepTarihi: new Date().toISOString()  // ✅ Otomatik bugünün tarihi
        };

        fetch("https://localhost:44365/api/ServisTalebi", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(talep)
        })
        .then(response => {
            if (response.ok) {
                alert("Servis talebi başarıyla oluşturuldu!");
                location.reload(); // Sayfayı yenile
            } else {
                alert("Bir hata oluştu: " + response.statusText);
            }
        })
        .catch(error => {
            console.error("Hata:", error);
            alert("Bir hata oluştu!");
        });
    }
</script>
